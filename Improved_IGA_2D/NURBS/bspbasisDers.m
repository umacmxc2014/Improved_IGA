function ders=bspbasisDers(U,p,u,n)
%������������uȡֵ�ڽڵ�����U���������Сֵ֮�䣬p��B�������ߣ�
% m=length(U); %�������������ڵ����� U �нڵ���ܸ��������ĸ���Ϊm-p-1;
% i=findspan(U,p,u);  %�����������������ҳ�u�����ڵĽڵ��ų���䣬��u����[u(i),u(i+1));
%����������������������N(i-p,p),N(i-p+1,p),....,N(i,p)��������(p+1)������Ϊ0��
%��������������������p��B�����ڵ�u����Ϊ��(p+1)�������ֱ��n�׵���n<=p;

ders=zeros(n+1,p+1);  
%����������������ders�洢p+1�������ֱ��n�׵���ֵ����һ��(n+1)*(p+1)�׾���
%������������ ders�ĵ�k�д洢��N(i-p,p),...,N(i,p)��(p+1)������ĵ�(k-1)�׵���k=1,2,...,n+1��

ndu=AllBasisFuns(U,p,u);
%������������    ndu=zeros(p+1,p+1);
%��������������������ndu������ǲ��ִ洢��0�Ļ������Ĵ����0��p��
%���������������� ndu�ĵ�j�д洢�Ĵ���Ϊ(j-1)�ε�B����ȫ����Ϊ0�Ļ���ndu��j�д洢����N(i-j,j),...,N(i,j);j=1,2,...,(p+1);
%���������������� ndu���������洢��Ӧ�Ľڵ��֣�

ders(1,:)=ndu(:,p+1)';%  ������������������(p+1)����0��p�λ�������ders�ĵ�һ���У���N(i-p,p),...,N(i,p);

a=zeros(2,p+1);%������������2*(p+1)�׾���洢�ռ��������a(k-1,j)��a(k-1,j-1)��
for r=0:p %������������  ���μ���N(i-p+r,p)��ֱ��n�׵���
	s1=1;s2=2;a(1,1)=1.0;
for k=1:n
	d=0;rk=r-k;pk=p-k;
if(rk>=0) 
    a(s2,1)=a(s1,1)/ndu(pk+2,rk+1); d=d+a(s2,1)*ndu(rk+1,pk+1);j1=1;
else
	j1=-rk;
end

if(r<=pk)
    a(s2,k+1)=-a(s1,k)/ndu(pk+2,r+1); d=d+a(s2,k+1)*ndu(r+1,pk+1);j2=k-1;
else
	j2=p-r;
end

for j=j1:j2
a(s2,j+1)=(a(s1,j+1)-a(s1,j))/ndu(pk+2,rk+j+1);d=d+a(s2,j+1)*ndu(rk+j+1,pk+1);
end


ders(k+1,r+1)=d;
j=s1;s1=s2;s2=j;
end
end

r=p;%������������B���������k�׵��������Ӧ��ϵ��
for k=1:n
	ders(k+1,:)=r*ders(k+1,:);   r=r*(p-k);%������������k�׵��������Ӧ��ϵ��
end
%disp(ders)
%�������������������� Test������������������������
% U=[0,0,0,1,2,3,4,4,5,5,5];
% p=2;  n=2;u=5/2;
%  ders=bspbasisDers(U,p,u,n)

	